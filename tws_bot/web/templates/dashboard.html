<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWS Signal Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        h1 { color: #333; text-align: center; }
        .container { max-width: 1200px; margin: 0 auto; }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; flex-wrap: wrap; gap: 15px; }
        .stat-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; flex: 1 1 calc(25% - 15px); min-width: 200px; box-sizing: border-box; }
        .signal { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px; background: white; }
        .entry { background-color: #d4edda; border-color: #c3e6cb; }
        .exit { background-color: #f8d7da; border-color: #f5c6cb; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
        .filter-buttons { margin: 20px 0; text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .filter-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: #007bff; color: white; text-decoration: none; display: inline-block; }
        .filter-btn.active { background: #0056b3; }
        .chart-link { color: #007bff; text-decoration: none; }
        .chart-link:hover { text-decoration: underline; }
        .indicators { font-size: 0.9em; color: #666; }
        .pagination { text-align: center; margin: 20px 0; }
        .positive { color: green; font-weight: bold; }
        .negative { color: red; font-weight: bold; }
        .watchlist { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TWS Signal Dashboard</h1>

        <!-- Zusammenfassungsstatistiken -->
        <div class="stats">
            <div class="stat-box">
                <h3>Gesamt Ticker</h3>
                <p>{{ total_tickers }}</p>
            </div>
            <div class="stat-box">
                <h3>Durchschnittliche Trefferquote</h3>
                <p>{{ "%.1f"|format(avg_rate if avg_rate is defined else 0) }}%</p>
            </div>
            <div class="stat-box">
                <h3>Aktive Signale</h3>
                <p>{{ total_signals }}</p>
            </div>
            <div class="stat-box">
                <h3>Historische Signale</h3>
                <p>{{ historical_signals|length }}</p>
            </div>
            <div class="stat-box">
                <h3>Performance Win-Rate</h3>
                <p>{{ "%.1f"|format(performance_stats.win_rate if performance_stats.win_rate is defined else 0) }}%</p>
            </div>
            <div class="stat-box">
                <h3>Gesamt Signale</h3>
                <p>{{ performance_stats.total_signals }}</p>
            </div>
            <div class="stat-box">
                <h3>Options-Signale</h3>
                <p>{{ options_signals|length }}</p>
            </div>
            <div class="stat-box">
                <h3>Ø IV Rank</h3>
                <p>{{ "%.1f"|format(options_stats.avg_iv_rank if options_stats.avg_iv_rank is defined else 0) }}</p>
            </div>
            <div class="stat-box">
                <h3>Ø Proximity</h3>
                <p>{{ "%.1f"|format(options_stats.avg_proximity_pct if options_stats.avg_proximity_pct is defined else 0) }}%</p>
            </div>
            <div class="stat-box">
                <h3>Portfolio-Wert</h3>
                <p>${{ "{:,.0f}".format(portfolio_data.portfolio_value if portfolio_data.portfolio_value is defined else 0) }}</p>
            </div>
            <div class="stat-box">
                <h3>Kaufkraft</h3>
                <p>${{ "{:,.0f}".format(portfolio_data.buying_power if portfolio_data.buying_power is defined else 0) }}</p>
            </div>
            <div class="stat-box">
                <h3>Cushion</h3>
                <p class="{% if (portfolio_data.cushion if portfolio_data.cushion is defined else 0) > 0.3 %}positive{% elif (portfolio_data.cushion if portfolio_data.cushion is defined else 0) > 0.1 %}warning{% else %}negative{% endif %}">{{ "%.1f"|format((portfolio_data.cushion if portfolio_data.cushion is defined else 0) * 100) }}%</p>
            </div>
            <div class="stat-box">
                <h3>Positionen</h3>
                <p>{{ portfolio_data.num_positions }}</p>
            </div>
        </div>

        <!-- Filter-Buttons -->
        <div class="filter-buttons">
            <a href="?filter=all" class="filter-btn {{ 'active' if filter_level == 'all' else '' }}">Alle</a>
            <a href="?filter=100" class="filter-btn {{ 'active' if filter_level == '100' else '' }}">100%</a>
            <a href="?filter=90" class="filter-btn {{ 'active' if filter_level == '90' else '' }}">90%+</a>
            <a href="?filter=80" class="filter-btn {{ 'active' if filter_level == '80' else '' }}">80%+</a>
            <a href="?filter=70" class="filter-btn {{ 'active' if filter_level == '70' else '' }}">70%+</a>
        </div>

        <!-- Aktuelle Signale -->
        <h2>Aktuelle Signale</h2>
        {% if signals %}
            {% for signal in signals %}
                <div class="signal {{ 'entry' if signal.type == 'entry' else 'exit' }}">
                    <strong>{{ signal.symbol }}</strong> - {{ signal.type.upper() }} bei ${{ "%.2f"|format(signal.price if signal.price is defined else 0) }}
                    {% if signal.quantity %}
                        <br>Quantität: {{ signal.quantity }} | Stop Loss: ${{ "%.2f"|format(signal.stop_loss if signal.stop_loss is defined else 0) }} | Take Profit: ${{ "%.2f"|format(signal.take_profit if signal.take_profit is defined else 0) }}
                    {% endif %}
                    <br>Grund: {{ signal.reason }}
                    <br><a href="/chart/{{ signal.symbol }}" class="chart-link">Chart anzeigen</a>
                </div>
            {% endfor %}
        {% else %}
            <p>Keine Signale gefunden.</p>
        {% endif %}

        <!-- Trefferquoten-Übersicht -->
        <h2>Trefferquoten-Übersicht</h2>
        {% for level, entries in hit_rates.items() %}
            {% if entries %}
                <h3>{{ level }}% Treffer ({{ entries|length }} Ticker)</h3>
                <table>
                    <tr>
                        <th>Ticker</th>
                        <th>Trefferquote</th>
                        <th>Aktive Indikatoren</th>
                        <th>Aktueller Preis</th>
                        <th>RSI</th>
                        <th>MA Kurz/Lang</th>
                        <th>MACD</th>
                        <th>Chart</th>
                    </tr>
                    {% for entry in entries %}
                        <tr>
                            <td><strong>{{ entry.symbol }}</strong></td>
                            <td>{{ "%.1f"|format(entry.rate if entry.rate is defined else 0) }}%</td>
                            <td>{{ entry.indicators }}</td>
                            <td>${{ "%.2f"|format(entry.current.price if entry.current.price is defined else 0) }}</td>
                            <td>{{ "%.1f"|format(entry.current.rsi if entry.current.rsi is defined else 0) }}</td>
                            <td>{{ "%.2f"|format(entry.current.ma_short if entry.current.ma_short is defined else 0) }} / {{ "%.2f"|format(entry.current.ma_long if entry.current.ma_long is defined else 0) }}</td>
                            <td>{% if entry.current.macd is defined %}{{ "%.4f"|format(entry.current.macd) }}{% else %}-{% endif %}</td>
                            <td><a href="/chart/{{ entry.symbol }}" class="chart-link">Anzeigen</a></td>
                        </tr>
                    {% endfor %}
                </table>
            {% endif %}
        {% endfor %}

        <!-- Historische Signale -->
        <h2>Letzte Historische Signale</h2>
        {% if historical_signals %}
            <table>
                <tr>
                    <th>Zeitstempel</th>
                    <th>Ticker</th>
                    <th>Typ</th>
                    <th>Preis</th>
                    <th>Quantität</th>
                    <th>Grund</th>
                </tr>
                {% for signal in historical_signals %}
                    <tr>
                        <td>{{ signal.timestamp }}</td>
                        <td>{{ signal.symbol }}</td>
                        <td>{{ signal.type }}</td>
                        <td>${{ "%.2f"|format(signal.price if signal.price is defined else 0) }}</td>
                        <td>{{ signal.quantity }}</td>
                        <td>{{ signal.reason }}</td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <p>Keine historischen Signale gefunden.</p>
        {% endif %}

        <!-- Options-Signale -->
        <h2>Options-Signale</h2>
        {% if options_signals %}
            <table>
                <tr>
                    <th>Zeitstempel</th>
                    <th>Strategie</th>
                    <th>Ticker</th>
                    <th>Underlying</th>
                    <th>Strike</th>
                    <th>Expiry</th>
                    <th>DTE</th>
                    <th>IV Rank</th>
                    <th>Proximity</th>
                    <th>Grund</th>
                </tr>
                {% for signal in options_signals %}
                    <tr>
                        <td>{{ signal.timestamp.strftime('%Y-%m-%d %H:%M') if signal.timestamp else 'N/A' }}</td>
                        <td><strong>{{ signal.signal_type }}</strong></td>
                        <td>{{ signal.symbol }}</td>
                        <td>${{ "%.2f"|format(signal.underlying_price) }}</td>
                        <td>${{ "%.2f"|format(signal.recommended_strike) if signal.recommended_strike else 'N/A' }}</td>
                        <td>{{ signal.recommended_expiry if signal.recommended_expiry else 'N/A' }}</td>
                        <td>{{ signal.recommended_dte if signal.recommended_dte else 'N/A' }}</td>
                        <td>{{ "%.1f"|format(signal.iv_rank) if signal.iv_rank else 'N/A' }}</td>
                        <td>{{ "%.1f"|format(signal.proximity_pct) if signal.proximity_pct else 'N/A' }}%</td>
                        <td>{{ signal.reason if signal.reason else 'N/A' }}</td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <p>Keine Options-Signale gefunden.</p>
        {% endif %}

        <!-- Portfolio-Übersicht -->
        <h2>Portfolio-Übersicht</h2>
        <div class="portfolio-summary">
            <div class="portfolio-stats">
                <div class="stat-box">
                    <h4>Netto-Liquidation</h4>
                    <p>${{ "{:,.0f}".format(portfolio_data.net_liquidation if portfolio_data.net_liquidation is defined else 0) }}</p>
                </div>
                <div class="stat-box">
                    <h4>Gesamt Cash</h4>
                    <p>${{ "{:,.0f}".format(portfolio_data.total_cash if portfolio_data.total_cash is defined else 0) }}</p>
                </div>
                <div class="stat-box">
                    <h4>Verfügbare Mittel</h4>
                    <p>${{ "{:,.0f}".format(portfolio_data.available_funds if portfolio_data.available_funds is defined else 0) }}</p>
                </div>
                <div class="stat-box">
                    <h4>Cushion Status</h4>
                    <p class="{% if (portfolio_data.cushion if portfolio_data.cushion is defined else 0) > 0.3 %}positive{% elif (portfolio_data.cushion if portfolio_data.cushion is defined else 0) > 0.1 %}warning{% else %}negative{% endif %}">
                        {{ "%.1f"|format((portfolio_data.cushion if portfolio_data.cushion is defined else 0) * 100) }}%
                        {% if (portfolio_data.cushion if portfolio_data.cushion is defined else 0) < 0.1 %}
                            <br><small>⚠️ Niedrig!</small>
                        {% elif (portfolio_data.cushion if portfolio_data.cushion is defined else 0) < 0.3 %}
                            <br><small>⚠️ Beachten</small>
                        {% else %}
                            <br><small>✅ Gut</small>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        {% if portfolio_data.positions %}
            <h3>Aktuelle Positionen</h3>
            <table>
                <tr>
                    <th>Symbol</th>
                    <th>Typ</th>
                    <th>Position</th>
                    <th>Durchschnittskosten</th>
                    <th>Marktwert</th>
                    <th>P&L unrealisiert</th>
                </tr>
                {% for position in portfolio_data.positions %}
                    {% if position.position != 0 %}
                        <tr>
                            <td><strong>{{ position.symbol }}</strong></td>
                            <td>{{ position.secType }}</td>
                            <td>{{ "{:,.0f}".format(position.position if position.position is defined else 0) }}</td>
                            <td>${{ "%.2f"|format(position.avgCost if position.avgCost is defined else 0) }}</td>
                            <td>${{ "{:,.0f}".format(position.marketValue if position.marketValue is defined else 0) }}</td>
                            <td class="{% if ((position.marketValue if position.marketValue is defined else 0) - ((position.position if position.position is defined else 0) * (position.avgCost if position.avgCost is defined else 0))) > 0 %}positive{% else %}negative{% endif %}">
                                ${{ "{:,.0f}".format((position.marketValue if position.marketValue is defined else 0) - ((position.position if position.position is defined else 0) * (position.avgCost if position.avgCost is defined else 0))) }}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </table>
        {% else %}
            <p>Keine aktiven Positionen gefunden.</p>
        {% endif %}

        <!-- Marktübersicht -->
        <h2>Marktübersicht</h2>
        {% if market_overview %}
            <div class="pagination">
                <p>Seite {{ current_page }} von {{ total_pages }} ({{ per_page }} pro Seite)</p>
                {% if current_page > 1 %}
                    <a href="?page={{ current_page - 1 }}&per_page={{ per_page }}" class="filter-btn">Vorherige</a>
                {% endif %}
                {% if current_page < total_pages %}
                    <a href="?page={{ current_page + 1 }}&per_page={{ per_page }}" class="filter-btn">Nächste</a>
                {% endif %}
            </div>
            <table>
                <tr>
                    <th>Symbol</th>
                    <th>Preis</th>
                    <th>Änderung (%)</th>
                    <th>RSI</th>
                    <th>MA Kurz/Lang</th>
                    <th>ATR</th>
                    <th>Volume</th>
                    <th>Fund. Score</th>
                    <th>Bewertung</th>
                    <th>Qualität</th>
                    <th>Strategien</th>
                    <th>Charts</th>
                </tr>
                {% for stock in market_overview %}
                    <tr>
                        <td><strong>{{ stock.symbol }}</strong></td>
                        <td>${{ "%.2f"|format(stock.price if stock.price is defined else 0) }}</td>
                        <td class="{% if (stock.change if stock.change is defined else 0) > 0 %}positive{% else %}negative{% endif %}">
                            {{ "%.2f"|format(stock.change if stock.change is defined else 0) }}%
                        </td>
                        <td>{{ "%.1f"|format(stock.rsi if stock.rsi is defined else 0) }}</td>
                        <td>{{ "%.2f"|format(stock.ma_short if stock.ma_short is defined else 0) }} / {{ "%.2f"|format(stock.ma_long if stock.ma_long is defined else 0) }}</td>
                        <td>{{ "%.4f"|format(stock.atr if stock.atr is defined else 0) }}</td>
                        <td>{{ "{:,}".format(stock.volume if stock.volume is defined else 0) }}</td>
                        <td>
                            {% if stock.fundamental_scores and stock.fundamental_scores.overall and stock.fundamental_scores.overall > 0 %}
                                <strong>{{ "%.1f"|format(stock.fundamental_scores.overall) }}</strong>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if stock.fundamental_ratings and stock.fundamental_ratings.value != 'N/A' %}
                                {{ stock.fundamental_ratings.value }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if stock.fundamental_ratings and stock.fundamental_ratings.quality != 'N/A' %}
                                {{ stock.fundamental_ratings.quality }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if stock.recommendations %}
                                {% for rec in stock.recommendations %}
                                    <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; margin: 1px; font-size: 0.8em;">{{ rec }}</span>
                                {% endfor %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <a href="/chart/{{ stock.symbol }}" class="chart-link">Chart</a>
                            {% if stock.fundamental_scores and stock.fundamental_scores.overall and stock.fundamental_scores.overall > 0 %}
                                | <a href="/fundamentals/{{ stock.symbol }}" class="chart-link">Fundamentals</a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <p>Keine Marktübersicht verfügbar.</p>
        {% endif %}

        <!-- Watchlist -->
        <div class="watchlist">
            <h2>Watchlist Übersicht</h2>
            <p>Alle {{ total_tickers }} Symbole werden oben in der Marktübersicht angezeigt.</p>
        </div>
    </div>

    <script>
        // Auto-refresh alle 60 Sekunden
        setInterval(function() {
            location.reload();
        }, 60000);
    </script>
</body>
</html>