version: '3.8'

services:
  # IB Gateway Container
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: ib-gateway
    restart: unless-stopped
    environment:
      # Paper Trading Credentials (WICHTIG: Eigene Credentials eintragen!)
      TWS_USERID: ${TWS_USERID:-your_username}
      TWS_PASSWORD: ${TWS_PASSWORD:-your_password}
      TRADING_MODE: ${TRADING_MODE:-paper}  # paper oder live
      READ_ONLY_API: ${READ_ONLY_API:-no}
      VNC_PASSWORD: ${VNC_PASSWORD:-vncpass}  # Für VNC-Zugriff
    ports:
      - "4002:4002"  # Paper Trading API Port
      - "4001:4001"  # Live Trading API Port
      - "5900:5900"  # VNC Server für GUI-Zugriff
    volumes:
      - ib-gateway-config:/root/Jts
      - ib-gateway-logs:/root/Jts/logs
    networks:
      - trading-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4002"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Trading Bot
  trading-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trading-bot
    restart: unless-stopped
    depends_on:
      ib-gateway:
        condition: service_healthy
    environment:
      # IB Gateway Verbindung
      IB_HOST: ib-gateway
      IB_PORT: ${IB_PORT:-4002}  # 4002=Paper, 4001=Live
      IB_CLIENT_ID: ${IB_CLIENT_ID:-1}
      
      # Trading Einstellungen
      IS_PAPER_TRADING: ${IS_PAPER_TRADING:-True}
      DRY_RUN: ${DRY_RUN:-False}
      
      # Kapital & Risiko
      ACCOUNT_SIZE: ${ACCOUNT_SIZE:-100000.0}
      MAX_RISK_PER_TRADE_PCT: ${MAX_RISK_PER_TRADE_PCT:-0.01}
      MAX_CONCURRENT_POSITIONS: ${MAX_CONCURRENT_POSITIONS:-5}
      
      # Watchlist (kommasepariert)
      WATCHLIST_STOCKS: ${WATCHLIST_STOCKS:-AAPL,MSFT,GOOGL,AMZN,TSLA}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      PYTHONUNBUFFERED: 1
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./plots:/app/plots
    networks:
      - trading-network
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/trading_data.db') else 1)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  trading-network:
    driver: bridge

volumes:
  ib-gateway-config:
    name: ib-gateway-config
  ib-gateway-logs:
    name: ib-gateway-logs
